%pre_head_template%
<figure class="text-center">
    <h1>Edit Configuration</h1>
</figure>
<form method="POST" action="/settingssave" enctype="multipart/form-data" novalidate>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="devicenamedesc">Device Name</span>
        <input type="text" class="form-control no-percent" aria-describedby="devicenamedesc" id="devicename"
            name="post_deviceName" maxlength="35" value="%pre_device_name%"
            onkeyup="this.value=this.value.replace(/\s+/g,'_');">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="devicequantitydesc">Device Quantity</span>
        <input type="text" class="form-control no-percent" aria-describedby="devicequantitydesc" id="devicequantity"
            name="post_deviceQuanttity" maxlength="2" value="%pre_device_quantity%">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttserverdesc">MQTT Server</span>
        <input type="text" class="form-control no-percent" aria-describedby="mqttserverdesc" id="mqttserver"
            name="post_mqttServer" maxlength="40" value="%pre_mqtt_server%">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttportdesc">MQTT Port</span>
        <input type="text" class="form-control no-percent" aria-describedby="mqttportdesc" id="mqttport"
            name="post_mqttPort" maxlength="5" value="%pre_mqtt_port%">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttuserdesc">MQTT User</span>
        <input type="text" class="form-control no-percent" aria-describedby="mqttuserdesc" id="mqttuser"
            name="post_mqttUser" maxlength="35" value="%pre_mqtt_user%">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttpassworddesc">MQTT Password</span>
        <input type="password" class="form-control no-percent" aria-describedby="mqttpassworddesc" id="mqttpassword"
            maxlength="35" name="post_mqttPassword" value="%pre_mqtt_pass%">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqtttopicdesc">MQTT Topic</span>
        <input type="text" class="form-control no-percent" aria-describedby="mqtttopicdesc" id="mqtttopic"
            name="post_mqttTopic" maxlength="35" value="%pre_mqtt_topic%"
            onkeyup="this.value=this.value.replace(/\s+/g,'_');">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttrefreshdesc">MQTT Refresh (sec)</span>
        <input type="text" class="form-control no-percent" aria-describedby="mqttrefreshdesc" id="mqttrefresh"
            maxlength="5" name="post_mqttRefresh" value="%pre_mqtt_refresh%">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqtttriggerdesc">MQTT Data Trigger Path</span>
        <input type="text" class="form-control no-percent" aria-describedby="mqtttrigerdesc" id="mqtttrigger"
            maxlength="80" name="post_mqtttrigger" value="%pre_mqtt_mqtttrigger%"
            onkeyup="this.value=this.value.replace(/\s+/g,'_');">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttjsondesc">MQTT Json Style</span>
        <div class="form-switch form-control mqtt-settings-switch" style="width:50%%; text-align: center;">
            <input type="checkbox" class="form-check-input form control" aria-describedby="mqttjsondesc" role="switch"
                id="mqttjson" name="post_mqttjson" value="true" %pre_mqtt_json%>
        </div>
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqtthadisc">HA Discovery</span>
        <div class="form-switch form-control mqtt-settings-switch" style="width:50%%; text-align: center;">
            <input type="checkbox" class="form-check-input form control" aria-describedby="mqtthadisc" role="switch"
                id="post_hadiscovery" name="post_hadiscovery" value="true" %pre_hadiscovery% onclick='haSwitch()'>
        </div>
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="webuicolormode">WebUI Dark Mode</span>
        <div class="form-switch form-control" style="width:50%%; text-align: center;">
            <input type="checkbox" class="form-check-input form control" aria-describedby="webuicolormode" role="switch"
                id="post_webuicolormode" name="post_webuicolormode" value="true" %pre_webuidarkmode%>
        </div>
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="led">LED brightness</span>
        <div class="form-switch form-control" style="width:50%%; text-align: center;">
            <input type="range" class="form-range" aria-describedby="led"
                id="post_led" name="post_led" value="%pre_led%" min="0" max="255">
        </div>
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="httpUserdesc">HTTP Username</span>
        <input type="text" class="form-control no-percent" aria-describedby="httpUserdesc" id="httpUser"
            name="post_httpUser" maxlength="40" value="%pre_http_user%">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="httpPassdesc">HTTP Password</span>
        <input type="password" class="form-control no-percent" aria-describedby="httpPassdesc" id="httpPass"
            name="post_httpPass" maxlength="40" value="%pre_http_pass%">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="ntptimezonedesc"><a
                href="https://github.com/nayarsystems/posix_tz_db/blob/master/zones.csv" target="_blank">NTP
                Timezone</a></span>
        <input type="text" class="form-control no-percent" aria-describedby="ntptimezonedesc" id="ntptimezone"
            name="post_ntptimezone" maxlength="40" value="%pre_ntptimezone%"
            placeholder="e.g GMT0 - empty to disable Sync">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="ntptimeservdesc">NTP Server</span>
        <input type="text" class="form-control no-percent" aria-describedby="ntptimeservdesc" id="ntptimeserv"
            name="post_ntptimeserv" maxlength="40" value="%pre_ntptimeserv%" placeholder="pool.ntp.org">
    </div>

    <div class="d-grid gap-2">
        <input id="submitButton" class="btn btn-primary" type="submit" value="Save settings">
</form>
<a class="btn btn-primary" href="/settings" role="button">Back</a>
</div>
<script>
    $(document).ready(function (load) {
        haSwitch();
    });


    (function () {
        // Alle Felder, die validiert werden sollen, per Klasse auswählen
        const fields = document.querySelectorAll('.no-percent');
        const submitButton = document.getElementById('submitButton');

        // Funktion, die ein Fehler-Element erstellt
        function createError() {
            const err = document.createElement('div');
            err.className = "text-danger small";
            err.style.display = "none";
            err.textContent = 'The percent sign is not allowed.';
            return err;
        }

        // Für jedes Feld dynamisch das Fehler-Element einfügen und Listener anhängen
        fields.forEach(function (field) {
            // Fehler-Element direkt unter der umschließenden .input-group einfügen
            const errorElem = createError();
            field.errorElem = errorElem;  // Referenz speichern
            field.parentNode.insertAdjacentElement('afterend', errorElem);

            field.addEventListener('input', function () {
                validateField(field);
                updateSubmit();
            });
        });

        // Prüft ein Feld – zeigt Fehler an, wenn es vom Default abweicht und "%" enthält
        function validateField(field) {
            if (field.value !== field.dataset.default && field.value.indexOf('%') !== -1) {
                field.errorElem.style.display = "block";
                return false;
            } else {
                field.errorElem.style.display = "none";
                return true;
            }
        }

        // Deaktiviert den Submit-Button, falls irgendein Feld einen Fehler hat
        function updateSubmit() {
            let disable = false;
            fields.forEach(function (field) {
                if (field.value !== field.dataset.default && field.value.indexOf('%') !== -1) {
                    disable = true;
                }
            });
            submitButton.disabled = disable;
        }

        // Beim Absenden nochmals alle Felder validieren
        document.getElementById('configForm').addEventListener('submit', function (e) {
            let valid = true;
            fields.forEach(function (field) {
                if (!validateField(field)) {
                    valid = false;
                }
            });
            if (!valid) e.preventDefault();
        });
    })();


    function haSwitch() {
        if (document.getElementById('post_hadiscovery').checked) {
            document.getElementById('mqttjson').checked = false;
            document.getElementById('mqttjson').disabled = true;
        }
        document.getElementById('mqttjson').disabled = document.getElementById('post_hadiscovery').checked;
    }
</script>
%pre_foot_template%
<p hidden></p>